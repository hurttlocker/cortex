<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cortex Knowledge Graph</title>
<style>
  :root {
    --bg: #0a0a0a;
    --panel: #111;
    --border: #222;
    --text: #e4e4e7;
    --muted: #71717a;
    --accent: #a855f7;
    --accent-dim: #7c3aed;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, 'Segoe UI', sans-serif; overflow: hidden; }

  .layout { display: flex; height: 100vh; }

  /* â”€â”€â”€ Sidebar â”€â”€â”€ */
  .sidebar {
    width: 300px; min-width: 300px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow-y: auto;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  .brand {
    font-size: 20px; font-weight: 700; padding: 20px 16px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .brand-icon { font-size: 24px; }
  .brand-text { color: var(--accent); }
  .brand-version { font-size: 11px; color: var(--muted); font-weight: 400; margin-left: auto; }

  .section-title {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--muted); padding: 16px 16px 6px; font-weight: 600;
  }

  .filter-group { padding: 4px 16px 8px; }
  .filter-group label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }

  .input-row { display: flex; gap: 6px; align-items: center; }
  input[type="text"], input[type="number"] {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); padding: 7px 10px; font-size: 13px; outline: none;
    transition: border-color 0.15s;
  }
  input:focus { border-color: var(--accent); }

  .btn {
    padding: 7px 14px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-dim); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--text); }
  .btn-full { width: 100%; }

  .range-row { display: flex; align-items: center; gap: 8px; }
  .range-row input[type="range"] { flex: 1; accent-color: var(--accent); }
  .range-val { font-size: 12px; color: var(--muted); min-width: 30px; text-align: right; }

  .checkbox-group { padding: 2px 16px; }
  .checkbox-group label {
    font-size: 13px; color: var(--text); display: flex; align-items: center;
    gap: 6px; cursor: pointer; padding: 3px 0;
  }
  .checkbox-group input { accent-color: var(--accent); }
  .edge-dot { display: inline-block; width: 8px; height: 8px; border-radius: 2px; }

  .type-legend { padding: 4px 16px; }
  .type-legend .legend-item {
    display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 12px; color: var(--muted);
  }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

  /* â”€â”€â”€ Detail Panel â”€â”€â”€ */
  .detail-panel {
    padding: 12px 16px; border-top: 1px solid var(--border);
    font-size: 13px; flex: 1; overflow-y: auto; min-height: 120px;
  }
  .detail-panel .fact-id { color: var(--accent); font-weight: 600; font-size: 15px; margin-bottom: 8px; }
  .detail-row { display: flex; padding: 3px 0; gap: 8px; }
  .detail-label { color: var(--muted); min-width: 80px; font-size: 12px; }
  .detail-value { color: var(--text); font-size: 13px; word-break: break-word; }
  .detail-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 600; background: rgba(168, 85, 247, 0.15); color: var(--accent);
  }
  .detail-actions { margin-top: 10px; display: flex; gap: 6px; }

  /* â”€â”€â”€ Browse Panel â”€â”€â”€ */
  .browse-results { max-height: 200px; overflow-y: auto; }
  .browse-item {
    padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer;
    font-size: 12px; transition: color 0.1s;
  }
  .browse-item:hover { color: var(--accent); }
  .browse-item .bi-id { color: var(--accent); font-weight: 600; }
  .browse-item .bi-text { color: var(--muted); }

  /* â”€â”€â”€ Graph Container â”€â”€â”€ */
  .canvas { flex: 1; position: relative; background: var(--bg); }

  /* â”€â”€â”€ Stats Bar â”€â”€â”€ */
  .stats-bar {
    position: absolute; bottom: 16px; left: 16px;
    background: rgba(17,17,17,0.92); border: 1px solid var(--border); border-radius: 10px;
    padding: 8px 16px; font-size: 12px; color: var(--muted);
    display: none; gap: 20px; backdrop-filter: blur(8px); z-index: 10;
  }
  .stats-bar .stat-val { color: var(--text); font-weight: 600; }

  /* â”€â”€â”€ Controls Help â”€â”€â”€ */
  .controls-help {
    position: absolute; top: 16px; right: 16px;
    background: rgba(17,17,17,0.85); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; font-size: 11px; color: var(--muted); line-height: 1.6;
    backdrop-filter: blur(8px); z-index: 10;
  }
  .controls-help kbd {
    background: #222; padding: 1px 5px; border-radius: 3px; font-size: 10px;
    border: 1px solid #333; color: var(--text);
  }

  /* â”€â”€â”€ Loading / Empty States â”€â”€â”€ */
  .center-msg {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    text-align: center; z-index: 5;
  }
  .center-msg .msg-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
  .center-msg .msg-title { font-size: 16px; color: var(--text); margin-bottom: 6px; }
  .center-msg .msg-sub { font-size: 13px; color: var(--muted); max-width: 320px; }

  .spinner {
    width: 28px; height: 28px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="layout">
  <div class="sidebar">
    <div class="brand">
      <span class="brand-icon">ðŸ§ </span>
      <span class="brand-text">Cortex</span>
      <span class="brand-version">Graph Explorer</span>
    </div>

    <!-- Search -->
    <div class="section-title">Search Facts</div>
    <div class="filter-group">
      <div class="input-row">
        <input type="text" id="searchInput" placeholder="Search by subject, predicate, object..." />
      </div>
      <div class="browse-results" id="browseResults" style="display:none"></div>
    </div>

    <!-- Root Fact -->
    <div class="section-title">Explore From</div>
    <div class="filter-group">
      <div class="input-row">
        <input type="number" id="factIdInput" placeholder="Fact ID" style="width:110px" />
        <input type="range" id="depthSlider" min="1" max="5" value="2" style="flex:1" />
        <span class="range-val" id="depthValue">2</span>
      </div>
      <button class="btn btn-primary btn-full" onclick="loadGraph()" style="margin-top:8px">
        Load Graph
      </button>
    </div>

    <!-- Confidence -->
    <div class="section-title">Filters</div>
    <div class="filter-group">
      <label>Min Confidence</label>
      <div class="range-row">
        <input type="range" id="confSlider" min="0" max="100" value="0" />
        <span class="range-val" id="confValue">0%</span>
      </div>
    </div>

    <!-- Edge Types -->
    <div class="section-title">Edge Types</div>
    <div class="checkbox-group" id="edgeToggles">
      <label><input type="checkbox" checked data-type="supports" /> <span class="edge-dot" style="background:#10b981"></span> Supports</label>
      <label><input type="checkbox" checked data-type="contradicts" /> <span class="edge-dot" style="background:#ef4444"></span> Contradicts</label>
      <label><input type="checkbox" checked data-type="relates_to" /> <span class="edge-dot" style="background:#3b82f6"></span> Relates To</label>
      <label><input type="checkbox" checked data-type="supersedes" /> <span class="edge-dot" style="background:#f59e0b"></span> Supersedes</label>
      <label><input type="checkbox" checked data-type="derived_from" /> <span class="edge-dot" style="background:#6b7280"></span> Derived From</label>
    </div>

    <!-- Display -->
    <div class="section-title">Display</div>
    <div class="checkbox-group">
      <label><input type="checkbox" id="showCoocs" /> Co-occurrences</label>
      <label><input type="checkbox" id="showLabels" checked /> Node Labels</label>
      <label><input type="checkbox" id="showArrows" checked /> Directional Arrows</label>
    </div>

    <!-- Node Legend -->
    <div class="section-title">Fact Types</div>
    <div class="type-legend" id="typeLegend"></div>

    <!-- Selected Fact -->
    <div class="section-title">Selected Fact</div>
    <div class="detail-panel" id="detailPanel">
      <span style="color:var(--muted);font-size:13px">Click a node to inspect</span>
    </div>
  </div>

  <!-- Graph -->
  <div class="canvas" id="graphCanvas">
    <div class="center-msg" id="emptyState">
      <div class="msg-icon">ðŸ§ </div>
      <div class="msg-title">Cortex Knowledge Graph</div>
      <div class="msg-sub">Enter a fact ID or search for facts to explore connections, edges, and co-occurrences in 3D.</div>
    </div>
    <div class="center-msg" id="loadingState" style="display:none">
      <div class="spinner"></div>
      <div class="msg-title">Loading graph...</div>
    </div>
    <div class="stats-bar" id="statsBar">
      Nodes: <span class="stat-val" id="statNodes">0</span>
      Edges: <span class="stat-val" id="statEdges">0</span>
      Co-ocs: <span class="stat-val" id="statCoocs">0</span>
    </div>
    <div class="controls-help" id="controlsHelp" style="display:none">
      <kbd>Left drag</kbd> Rotate &nbsp; <kbd>Right drag</kbd> Pan &nbsp; <kbd>Scroll</kbd> Zoom<br>
      <kbd>Click</kbd> Select node &nbsp; <kbd>Hover</kbd> Tooltip
    </div>
  </div>
</div>

<script src="https://unpkg.com/3d-force-graph@1"></script>
<script>
// â”€â”€â”€ Constants â”€â”€â”€
const EDGE_COLORS = {
  supports: '#10b981', contradicts: '#ef4444', relates_to: '#3b82f6',
  supersedes: '#f59e0b', derived_from: '#6b7280'
};

const FACT_TYPE_COLORS = {
  kv: '#a855f7',
  temporal: '#06b6d4',
  identity: '#f97316',
  state: '#84cc16',
  preference: '#ec4899',
  decision: '#eab308',
  location: '#14b8a6',
  relationship: '#f43f5e'
};

const AGENT_COLORS = ['#a855f7', '#06b6d4', '#f97316', '#ec4899', '#84cc16', '#eab308', '#f43f5e', '#14b8a6'];
const agentColorMap = {};
let agentIdx = 0;
function agentColor(id) {
  if (!id) return '#555';
  if (!agentColorMap[id]) { agentColorMap[id] = AGENT_COLORS[agentIdx++ % AGENT_COLORS.length]; }
  return agentColorMap[id];
}

// â”€â”€â”€ State â”€â”€â”€
let Graph = null;
let graphData = null;
let selectedNode = null;
let searchDebounce = null;

// â”€â”€â”€ Build type legend â”€â”€â”€
function buildTypeLegend() {
  const el = document.getElementById('typeLegend');
  el.innerHTML = Object.entries(FACT_TYPE_COLORS).map(([type, color]) =>
    `<div class="legend-item"><span class="legend-dot" style="background:${color}"></span>${type}</div>`
  ).join('');
}

// â”€â”€â”€ Initialize 3D Graph â”€â”€â”€
function initGraph() {
  const container = document.getElementById('graphCanvas');

  Graph = ForceGraph3D()(container)
    .backgroundColor('#0a0a0a')
    .showNavInfo(false)
    .nodeRelSize(5)
    .nodeVal(n => 0.5 + n.confidence * 2)
    .nodeColor(n => {
      if (selectedNode && n.id === selectedNode.id) return '#fff';
      return FACT_TYPE_COLORS[n.type] || '#666';
    })
    .nodeOpacity(0.92)
    .nodeLabel(n => `#${n.id}: ${n.subject}\n${n.predicate}: ${truncate(n.object, 60)}\nConfidence: ${(n.confidence * 100).toFixed(0)}%\nType: ${n.type}${n.agent_id ? '\nAgent: ' + n.agent_id : ''}`)
    .linkColor(link => {
      if (link._isCooc) return '#333';
      return EDGE_COLORS[link.type] || '#444';
    })
    .linkOpacity(link => link._isCooc ? 0.25 : 0.6)
    .linkWidth(link => {
      if (link._isCooc) return 0.3 + Math.min(link.count / 5, 2);
      return 0.5 + link.confidence * 3;
    })
    .linkDirectionalArrowLength(link => {
      if (link._isCooc) return 0;
      return document.getElementById('showArrows').checked ? 4 : 0;
    })
    .linkDirectionalArrowRelPos(1)
    .linkLineDash(link => link._isCooc ? [2, 2] : null)
    .onNodeClick(node => {
      selectedNode = node;
      showDetail(node);
      Graph.nodeColor(Graph.nodeColor()); // force refresh colors

      // Focus on node
      const dist = 120;
      const pos = node;
      Graph.cameraPosition(
        { x: pos.x + dist, y: pos.y + dist / 2, z: pos.z + dist },
        pos,
        1200
      );
    })
    .onNodeHover(node => {
      container.style.cursor = node ? 'pointer' : 'default';
    })
    .warmupTicks(80)
    .cooldownTicks(120)
    .d3AlphaDecay(0.04)
    .d3VelocityDecay(0.3);

  // Add particle effects on edges
  Graph.linkDirectionalParticles(link => link._isCooc ? 0 : 2)
    .linkDirectionalParticleWidth(link => 0.5 + link.confidence * 1.5)
    .linkDirectionalParticleSpeed(0.005)
    .linkDirectionalParticleColor(link => EDGE_COLORS[link.type] || '#444');
}

// â”€â”€â”€ Load Graph â”€â”€â”€
async function loadGraph() {
  const factId = document.getElementById('factIdInput').value.trim();
  if (!factId) return;

  const depth = document.getElementById('depthSlider').value;

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('controlsHelp').style.display = 'none';
  document.getElementById('statsBar').style.display = 'none';

  try {
    const resp = await fetch(`/api/graph?fact_id=${factId}&depth=${depth}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    graphData = await resp.json();

    document.getElementById('loadingState').style.display = 'none';

    if (!graphData.nodes || graphData.nodes.length === 0) {
      document.getElementById('emptyState').style.display = 'block';
      document.querySelector('#emptyState .msg-title').textContent = 'No graph data';
      document.querySelector('#emptyState .msg-sub').textContent = `Fact #${factId} has no edges or connections yet. Try running 'cortex infer' to generate relationship edges.`;
      return;
    }

    renderGraph();
  } catch (err) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.querySelector('#emptyState .msg-title').textContent = 'Error';
    document.querySelector('#emptyState .msg-sub').textContent = err.message;
  }
}

// â”€â”€â”€ Render Graph â”€â”€â”€
function renderGraph() {
  if (!graphData) return;

  const confMin = parseInt(document.getElementById('confSlider').value) / 100;

  // Collect active edge types
  const activeTypes = new Set();
  document.querySelectorAll('#edgeToggles input:checked').forEach(cb => activeTypes.add(cb.dataset.type));

  // Filter nodes by confidence
  const nodes = graphData.nodes.filter(n => n.confidence >= confMin);
  const nodeIds = new Set(nodes.map(n => n.id));

  // Build links from edges
  const links = [];

  // Explicit edges
  if (graphData.edges) {
    graphData.edges
      .filter(e => activeTypes.has(e.type) && nodeIds.has(e.source) && nodeIds.has(e.target))
      .forEach(e => links.push({ ...e, _isCooc: false }));
  }

  // Co-occurrences
  if (document.getElementById('showCoocs').checked && graphData.cooccurrences) {
    graphData.cooccurrences
      .filter(c => nodeIds.has(c.a) && nodeIds.has(c.b))
      .forEach(c => links.push({
        source: c.a, target: c.b, type: 'cooccurrence',
        confidence: 0.3, count: c.count, _isCooc: true
      }));
  }

  // Update stats
  document.getElementById('statsBar').style.display = 'flex';
  document.getElementById('controlsHelp').style.display = 'block';
  document.getElementById('statNodes').textContent = nodes.length;
  document.getElementById('statEdges').textContent = graphData.edges?.length || 0;
  document.getElementById('statCoocs').textContent = graphData.cooccurrences?.length || 0;

  // Node labels
  const showLabels = document.getElementById('showLabels').checked;

  Graph
    .nodeThreeObject(showLabels ? node => {
      const sprite = new SpriteText(truncate(node.subject, 24));
      sprite.color = '#aaa';
      sprite.textHeight = 3;
      sprite.position.y = 8;
      return sprite;
    } : null)
    .nodeThreeObjectExtend(showLabels)
    .graphData({ nodes: JSON.parse(JSON.stringify(nodes)), links: JSON.parse(JSON.stringify(links)) });
}

// â”€â”€â”€ Detail Panel â”€â”€â”€
function showDetail(d) {
  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <div class="fact-id">#${d.id}</div>
    <div class="detail-row"><span class="detail-label">Subject</span><span class="detail-value">${esc(d.subject)}</span></div>
    <div class="detail-row"><span class="detail-label">Predicate</span><span class="detail-value">${esc(d.predicate)}</span></div>
    <div class="detail-row"><span class="detail-label">Object</span><span class="detail-value">${esc(d.object)}</span></div>
    <div class="detail-row"><span class="detail-label">Type</span><span class="detail-value"><span class="detail-badge" style="background:${FACT_TYPE_COLORS[d.type] || '#555'}22;color:${FACT_TYPE_COLORS[d.type] || '#999'}">${d.type}</span></span></div>
    <div class="detail-row"><span class="detail-label">Confidence</span><span class="detail-value">${(d.confidence * 100).toFixed(1)}%</span></div>
    <div class="detail-row"><span class="detail-label">Agent</span><span class="detail-value">${d.agent_id || '(global)'}</span></div>
    <div class="detail-actions">
      <button class="btn btn-sm btn-ghost" onclick="expandFrom(${d.id})">Expand from here</button>
    </div>
  `;
}

function expandFrom(factId) {
  document.getElementById('factIdInput').value = factId;
  loadGraph();
}

// â”€â”€â”€ Search â”€â”€â”€
async function searchFacts(query) {
  if (!query || query.length < 2) {
    document.getElementById('browseResults').style.display = 'none';
    return;
  }
  try {
    const resp = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=15`);
    if (!resp.ok) return;
    const results = await resp.json();
    const el = document.getElementById('browseResults');
    if (!results.facts || results.facts.length === 0) {
      el.innerHTML = '<div class="browse-item" style="cursor:default"><span class="bi-text">No results</span></div>';
      el.style.display = 'block';
      return;
    }
    el.innerHTML = results.facts.map(f =>
      `<div class="browse-item" onclick="selectSearchResult(${f.id})">
        <span class="bi-id">#${f.id}</span> ${esc(f.subject)} <span class="bi-text">${esc(truncate(f.predicate + ': ' + f.object, 50))}</span>
      </div>`
    ).join('');
    el.style.display = 'block';
  } catch (e) {
    console.error('Search error:', e);
  }
}

function selectSearchResult(factId) {
  document.getElementById('factIdInput').value = factId;
  document.getElementById('browseResults').style.display = 'none';
  loadGraph();
}

// â”€â”€â”€ Highlight matching nodes â”€â”€â”€
function highlightSearch(query) {
  if (!Graph || !graphData) return;
  if (!query) {
    Graph.nodeColor(n => {
      if (selectedNode && n.id === selectedNode.id) return '#fff';
      return FACT_TYPE_COLORS[n.type] || '#666';
    });
    Graph.nodeOpacity(0.92);
    return;
  }
  const q = query.toLowerCase();
  Graph.nodeColor(n => {
    const match = (n.subject + n.predicate + n.object).toLowerCase().includes(q);
    if (match) return '#fff';
    return FACT_TYPE_COLORS[n.type] || '#666';
  });
}

// â”€â”€â”€ Utilities â”€â”€â”€
function truncate(s, n) { return s && s.length > n ? s.substring(0, n) + 'â€¦' : (s || ''); }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

// â”€â”€â”€ Event Listeners â”€â”€â”€
document.getElementById('depthSlider').addEventListener('input', e => {
  document.getElementById('depthValue').textContent = e.target.value;
});

document.getElementById('confSlider').addEventListener('input', e => {
  document.getElementById('confValue').textContent = e.target.value + '%';
  if (graphData) renderGraph();
});

document.querySelectorAll('#edgeToggles input').forEach(cb => {
  cb.addEventListener('change', () => { if (graphData) renderGraph(); });
});

['showCoocs', 'showLabels', 'showArrows'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => { if (graphData) renderGraph(); });
});

document.getElementById('searchInput').addEventListener('input', e => {
  const q = e.target.value.trim();
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(() => {
    searchFacts(q);
    highlightSearch(q);
  }, 300);
});

document.getElementById('factIdInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') loadGraph();
});

// â”€â”€â”€ Init â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  buildTypeLegend();
  initGraph();

  // URL param support
  const params = new URLSearchParams(window.location.search);
  if (params.get('fact_id')) {
    document.getElementById('factIdInput').value = params.get('fact_id');
    if (params.get('depth')) {
      document.getElementById('depthSlider').value = params.get('depth');
      document.getElementById('depthValue').textContent = params.get('depth');
    }
    loadGraph();
  }

  // Embedded data support
  if (window.__CORTEX_GRAPH_DATA__) {
    graphData = window.__CORTEX_GRAPH_DATA__;
    renderGraph();
  }
});
</script>
<!-- SpriteText for 3D labels -->
<script src="https://unpkg.com/three-spritetext"></script>
</body>
</html>
