<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cortex Knowledge Graph</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root {
    --bg: #0a0a0a;
    --panel: #111;
    --border: #222;
    --text: #e4e4e7;
    --muted: #71717a;
    --accent: #a855f7;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }

  .layout { display: flex; height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 280px; min-width: 280px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow-y: auto;
  }
  .sidebar h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); padding: 16px 16px 8px; }
  .sidebar .brand { font-size: 18px; font-weight: 700; padding: 16px; border-bottom: 1px solid var(--border); color: var(--accent); letter-spacing: 0; text-transform: none; }

  .filter-group { padding: 8px 16px; }
  .filter-group label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
  .filter-group input[type="range"] { width: 100%; accent-color: var(--accent); }
  .filter-group input[type="text"] {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); padding: 6px 10px; font-size: 13px; outline: none;
  }
  .filter-group input[type="text"]:focus { border-color: var(--accent); }
  .filter-group .value { font-size: 11px; color: var(--muted); text-align: right; }

  .checkbox-group { padding: 4px 16px; }
  .checkbox-group label { font-size: 13px; color: var(--text); display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 3px 0; }
  .checkbox-group input { accent-color: var(--accent); }

  .detail-panel {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    font-size: 13px;
    flex: 1;
    overflow-y: auto;
  }
  .detail-panel .fact-id { color: var(--accent); font-weight: 600; }
  .detail-panel .fact-row { margin: 4px 0; }
  .detail-panel .fact-label { color: var(--muted); display: inline-block; width: 80px; }
  .detail-panel .fact-value { color: var(--text); }

  /* Graph canvas */
  .canvas { flex: 1; position: relative; }
  .canvas svg { width: 100%; height: 100%; }

  /* Stats bar */
  .stats-bar {
    position: absolute; bottom: 12px; left: 12px;
    background: rgba(17,17,17,0.9); border: 1px solid var(--border); border-radius: 8px;
    padding: 6px 12px; font-size: 12px; color: var(--muted);
    display: flex; gap: 16px;
  }
  .stats-bar span { color: var(--text); }

  /* Tooltip */
  .tooltip {
    position: absolute; pointer-events: none;
    background: rgba(17,17,17,0.95); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 12px; font-size: 12px; max-width: 320px;
    display: none; z-index: 100;
  }
  .tooltip .tt-subject { color: var(--accent); font-weight: 600; }
  .tooltip .tt-row { margin: 2px 0; }

  /* Edge type colors */
  .edge-supports { stroke: #10b981; }
  .edge-contradicts { stroke: #ef4444; }
  .edge-relates_to { stroke: #3b82f6; }
  .edge-supersedes { stroke: #f59e0b; }
  .edge-derived_from { stroke: #6b7280; }

  /* Agent colors */
  .agent-badge {
    display: inline-block; padding: 1px 6px; border-radius: 4px;
    font-size: 11px; font-weight: 600;
  }

  /* Loading */
  .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--muted); font-size: 14px; }
</style>
</head>
<body>
<div class="layout">
  <div class="sidebar">
    <div class="brand">ðŸ§  Cortex Graph</div>

    <h2>Search</h2>
    <div class="filter-group">
      <input type="text" id="searchInput" placeholder="Search nodes..." />
    </div>

    <h2>Root Fact</h2>
    <div class="filter-group">
      <label>Fact ID</label>
      <input type="text" id="factIdInput" placeholder="e.g. 123" />
      <div style="margin-top:4px">
        <label>Depth</label>
        <input type="range" id="depthSlider" min="1" max="5" value="2" />
        <div class="value" id="depthValue">2</div>
      </div>
      <button onclick="loadGraph()" style="margin-top:8px; width:100%; padding:6px; background:var(--accent); border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:13px;">Load Graph</button>
    </div>

    <h2>Filters</h2>
    <div class="filter-group">
      <label>Min Confidence</label>
      <input type="range" id="confSlider" min="0" max="100" value="0" />
      <div class="value" id="confValue">0%</div>
    </div>

    <h2>Edge Types</h2>
    <div class="checkbox-group" id="edgeToggles">
      <label><input type="checkbox" checked data-type="supports" /> <span style="color:#10b981">â– </span> Supports</label>
      <label><input type="checkbox" checked data-type="contradicts" /> <span style="color:#ef4444">â– </span> Contradicts</label>
      <label><input type="checkbox" checked data-type="relates_to" /> <span style="color:#3b82f6">â– </span> Relates To</label>
      <label><input type="checkbox" checked data-type="supersedes" /> <span style="color:#f59e0b">â– </span> Supersedes</label>
      <label><input type="checkbox" checked data-type="derived_from" /> <span style="color:#6b7280">â– </span> Derived From</label>
    </div>

    <h2>Show</h2>
    <div class="checkbox-group">
      <label><input type="checkbox" id="showCoocs" /> Co-occurrences</label>
      <label><input type="checkbox" id="showLabels" checked /> Node labels</label>
    </div>

    <h2>Selected Fact</h2>
    <div class="detail-panel" id="detailPanel">
      <span style="color:var(--muted)">Click a node to view details</span>
    </div>
  </div>

  <div class="canvas" id="graphCanvas">
    <div class="loading" id="loadingMsg">Enter a fact ID and click Load Graph</div>
    <div class="tooltip" id="tooltip"></div>
    <div class="stats-bar" id="statsBar" style="display:none">
      Nodes: <span id="statNodes">0</span> &nbsp;
      Edges: <span id="statEdges">0</span> &nbsp;
      Co-ocs: <span id="statCoocs">0</span>
    </div>
  </div>
</div>

<script>
const EDGE_COLORS = {
  supports: '#10b981', contradicts: '#ef4444', relates_to: '#3b82f6',
  supersedes: '#f59e0b', derived_from: '#6b7280'
};

const AGENT_COLORS = ['#a855f7', '#06b6d4', '#f97316', '#ec4899', '#84cc16', '#eab308'];
const agentColorMap = {};
let agentColorIdx = 0;

function getAgentColor(agentId) {
  if (!agentId) return '#71717a';
  if (!agentColorMap[agentId]) {
    agentColorMap[agentId] = AGENT_COLORS[agentColorIdx % AGENT_COLORS.length];
    agentColorIdx++;
  }
  return agentColorMap[agentId];
}

let simulation, svg, gLinks, gNodes, gLabels, gCoocs;
let graphData = null;

function initSVG() {
  const container = document.getElementById('graphCanvas');
  const w = container.clientWidth;
  const h = container.clientHeight;

  svg = d3.select(container).append('svg')
    .attr('width', w).attr('height', h);

  const g = svg.append('g');

  // Zoom
  const zoom = d3.zoom()
    .scaleExtent([0.1, 8])
    .on('zoom', (e) => g.attr('transform', e.transform));
  svg.call(zoom);

  // Arrow markers
  const defs = svg.append('defs');
  Object.entries(EDGE_COLORS).forEach(([type, color]) => {
    defs.append('marker')
      .attr('id', `arrow-${type}`)
      .attr('viewBox', '0 0 10 6').attr('refX', 20).attr('refY', 3)
      .attr('markerWidth', 8).attr('markerHeight', 6)
      .attr('orient', 'auto')
      .append('path').attr('d', 'M0,0 L10,3 L0,6').attr('fill', color);
  });

  gCoocs = g.append('g').attr('class', 'coocs');
  gLinks = g.append('g').attr('class', 'links');
  gNodes = g.append('g').attr('class', 'nodes');
  gLabels = g.append('g').attr('class', 'labels');

  return { w, h, g };
}

async function loadGraph() {
  const factId = document.getElementById('factIdInput').value.trim();
  if (!factId) return;

  const depth = document.getElementById('depthSlider').value;
  document.getElementById('loadingMsg').textContent = 'Loading...';
  document.getElementById('loadingMsg').style.display = 'block';

  try {
    const url = `/api/graph?fact_id=${factId}&depth=${depth}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    graphData = await resp.json();
    renderGraph();
  } catch (err) {
    document.getElementById('loadingMsg').textContent = `Error: ${err.message}`;
  }
}

function renderGraph() {
  if (!graphData || !graphData.nodes) return;

  document.getElementById('loadingMsg').style.display = 'none';
  document.getElementById('statsBar').style.display = 'flex';
  document.getElementById('statNodes').textContent = graphData.nodes.length;
  document.getElementById('statEdges').textContent = graphData.edges?.length || 0;
  document.getElementById('statCoocs').textContent = graphData.cooccurrences?.length || 0;

  const container = document.getElementById('graphCanvas');
  const w = container.clientWidth;
  const h = container.clientHeight;

  // Build D3 data
  const nodes = graphData.nodes.map(n => ({
    ...n, x: w / 2 + (Math.random() - 0.5) * 200, y: h / 2 + (Math.random() - 0.5) * 200
  }));
  const nodeById = Object.fromEntries(nodes.map(n => [n.id, n]));

  // Filter edges based on toggles
  const activeTypes = new Set();
  document.querySelectorAll('#edgeToggles input:checked').forEach(cb => activeTypes.add(cb.dataset.type));

  const edges = (graphData.edges || [])
    .filter(e => activeTypes.has(e.type))
    .map(e => ({ ...e, source: nodeById[e.source], target: nodeById[e.target] }))
    .filter(e => e.source && e.target);

  const coocs = (graphData.cooccurrences || [])
    .map(c => ({ ...c, source: nodeById[c.a], target: nodeById[c.b] }))
    .filter(c => c.source && c.target);

  const confMin = parseInt(document.getElementById('confSlider').value) / 100;

  // Simulation
  if (simulation) simulation.stop();
  simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
    .force('charge', d3.forceManyBody().strength(-300))
    .force('center', d3.forceCenter(w / 2, h / 2))
    .force('collision', d3.forceCollide(30));

  // Co-occurrence lines
  const showCoocs = document.getElementById('showCoocs').checked;
  gCoocs.selectAll('*').remove();
  if (showCoocs) {
    gCoocs.selectAll('line')
      .data(coocs).enter().append('line')
      .attr('stroke', '#333').attr('stroke-width', d => Math.min(d.count / 3, 4))
      .attr('stroke-dasharray', '4,4').attr('opacity', 0.4);
  }

  // Edges
  gLinks.selectAll('*').remove();
  gLinks.selectAll('line')
    .data(edges).enter().append('line')
    .attr('stroke', d => EDGE_COLORS[d.type] || '#555')
    .attr('stroke-width', d => 1 + d.confidence * 3)
    .attr('opacity', d => 0.3 + d.confidence * 0.7)
    .attr('marker-end', d => `url(#arrow-${d.type})`);

  // Nodes
  gNodes.selectAll('*').remove();
  gNodes.selectAll('circle')
    .data(nodes).enter().append('circle')
    .attr('r', d => 6 + d.confidence * 10)
    .attr('fill', d => getAgentColor(d.agent_id))
    .attr('stroke', '#333').attr('stroke-width', 1)
    .attr('opacity', d => d.confidence < confMin ? 0.15 : (0.3 + d.confidence * 0.7))
    .attr('cursor', 'pointer')
    .on('mouseover', (e, d) => showTooltip(e, d))
    .on('mouseout', () => hideTooltip())
    .on('click', (e, d) => selectNode(d))
    .call(d3.drag()
      .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
      .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
    );

  // Labels
  const showLabels = document.getElementById('showLabels').checked;
  gLabels.selectAll('*').remove();
  if (showLabels) {
    gLabels.selectAll('text')
      .data(nodes).enter().append('text')
      .text(d => truncate(d.subject, 20))
      .attr('font-size', 10).attr('fill', '#999')
      .attr('dx', 14).attr('dy', 4)
      .attr('opacity', d => d.confidence < confMin ? 0.1 : 0.8);
  }

  // Tick
  simulation.on('tick', () => {
    gLinks.selectAll('line')
      .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    gCoocs.selectAll('line')
      .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    gNodes.selectAll('circle').attr('cx', d => d.x).attr('cy', d => d.y);
    gLabels.selectAll('text').attr('x', d => d.x).attr('y', d => d.y);
  });
}

function showTooltip(event, d) {
  const tt = document.getElementById('tooltip');
  tt.innerHTML = `
    <div class="tt-subject">#${d.id}: ${d.subject}</div>
    <div class="tt-row">${d.predicate}: ${d.object}</div>
    <div class="tt-row">Type: ${d.type} | Confidence: ${(d.confidence * 100).toFixed(0)}%</div>
    ${d.agent_id ? `<div class="tt-row">Agent: ${d.agent_id}</div>` : ''}
  `;
  tt.style.display = 'block';
  tt.style.left = (event.pageX + 12) + 'px';
  tt.style.top = (event.pageY - 12) + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

function selectNode(d) {
  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <div class="fact-id">#${d.id}</div>
    <div class="fact-row"><span class="fact-label">Subject</span><span class="fact-value">${d.subject}</span></div>
    <div class="fact-row"><span class="fact-label">Predicate</span><span class="fact-value">${d.predicate}</span></div>
    <div class="fact-row"><span class="fact-label">Object</span><span class="fact-value">${d.object}</span></div>
    <div class="fact-row"><span class="fact-label">Type</span><span class="fact-value">${d.type}</span></div>
    <div class="fact-row"><span class="fact-label">Confidence</span><span class="fact-value">${(d.confidence * 100).toFixed(1)}%</span></div>
    <div class="fact-row"><span class="fact-label">Agent</span><span class="fact-value">${d.agent_id || '(global)'}</span></div>
  `;
  // Highlight
  gNodes.selectAll('circle').attr('stroke', n => n.id === d.id ? '#fff' : '#333').attr('stroke-width', n => n.id === d.id ? 2 : 1);
}

function truncate(s, n) {
  return s && s.length > n ? s.substring(0, n) + 'â€¦' : (s || '');
}

// Filter event listeners
document.getElementById('depthSlider').addEventListener('input', (e) => {
  document.getElementById('depthValue').textContent = e.target.value;
});
document.getElementById('confSlider').addEventListener('input', (e) => {
  document.getElementById('confValue').textContent = e.target.value + '%';
  if (graphData) renderGraph();
});
document.querySelectorAll('#edgeToggles input').forEach(cb => {
  cb.addEventListener('change', () => { if (graphData) renderGraph(); });
});
document.getElementById('showCoocs').addEventListener('change', () => { if (graphData) renderGraph(); });
document.getElementById('showLabels').addEventListener('change', () => { if (graphData) renderGraph(); });
document.getElementById('searchInput').addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase();
  if (!q) {
    gNodes.selectAll('circle').attr('opacity', d => 0.3 + d.confidence * 0.7);
    gLabels.selectAll('text').attr('opacity', 0.8);
    return;
  }
  gNodes.selectAll('circle').attr('opacity', d =>
    (d.subject + d.predicate + d.object).toLowerCase().includes(q) ? 1 : 0.08
  );
  gLabels.selectAll('text').attr('opacity', d =>
    (d.subject + d.predicate + d.object).toLowerCase().includes(q) ? 1 : 0.08
  );
});

// Also support loading from URL params or embedded data
document.addEventListener('DOMContentLoaded', () => {
  initSVG();

  // Check URL params
  const params = new URLSearchParams(window.location.search);
  if (params.get('fact_id')) {
    document.getElementById('factIdInput').value = params.get('fact_id');
    if (params.get('depth')) {
      document.getElementById('depthSlider').value = params.get('depth');
      document.getElementById('depthValue').textContent = params.get('depth');
    }
    loadGraph();
  }

  // Check for embedded data (for static HTML export)
  if (window.__CORTEX_GRAPH_DATA__) {
    graphData = window.__CORTEX_GRAPH_DATA__;
    renderGraph();
  }
});
</script>
</body>
</html>
