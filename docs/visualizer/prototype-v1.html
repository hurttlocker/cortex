<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cortex Visualizer v1 — Prototype</title>
  <style>
    :root {
      --bg: #000;
      --panel: #0a0a0a;
      --panel2: #101010;
      --text: #fff;
      --muted: #a1a1aa;
      --border: #262626;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
    .side { border-right: 1px solid var(--border); background: #050505; padding: 16px 14px; }
    .brand { font-size: 13px; letter-spacing: .1em; text-transform: uppercase; margin-bottom: 16px; color: #e4e4e7; }
    .nav { display: grid; gap: 6px; }
    .nav div { padding: 9px 10px; border-radius: 8px; color: var(--muted); font-size: 13px; border: 1px solid transparent; }
    .nav .active { color: #fff; background: var(--panel2); border-color: var(--border); }
    .main { padding: 20px; }
    .top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    h1 { margin: 0; font-size: 21px; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .btn { border: 1px solid var(--border); color: #fff; background: var(--panel2); border-radius: 8px; padding: 8px 12px; font-size: 12px; cursor: pointer; }
    .meta { color: var(--muted); font-size: 11px; margin-bottom: 10px; }
    .grid4 { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-bottom: 12px; }
    .card { border: 1px solid var(--border); background: var(--panel); border-radius: 10px; padding: 12px; }
    .k { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .06em; }
    .v { margin-top: 6px; font-size: 35px; line-height: 1.1; font-weight: 650; }
    .small { color: var(--muted); font-size: 12px; }
    .row { display: grid; grid-template-columns: 1.6fr 1fr; gap: 12px; margin-bottom: 12px; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 13px; font-weight: 600; }
    .pill { border: 1px solid var(--border); border-radius: 999px; padding: 3px 9px; font-size: 11px; color: var(--muted); background: #080808; }
    .status-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-bottom: 10px; }
    .status { border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #090909; }
    .dot { width: 8px; height: 8px; border-radius: 99px; display: inline-block; margin-right: 6px; }
    .ok { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad { background: var(--bad); }
    .label { color: var(--muted); font-size: 11px; }
    .value { font-size: 15px; margin-top: 6px; }
    .spark { height: 125px; border: 1px dashed #222; border-radius: 8px; padding: 8px; background: #060606; }
    svg { width: 100%; height: 100%; }
    .axis { stroke: #1f1f1f; stroke-width: 1; }
    .line { fill: none; stroke: #fff; stroke-width: 2; }
    .meter { margin: 6px 0 10px; height: 8px; background: #141414; border-radius: 999px; overflow: hidden; border: 1px solid #1f1f1f; }
    .meter > span { display: block; height: 100%; background: #fff; }
    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { text-align: left; border-top: 1px solid #1f1f1f; padding: 8px 6px; }
    .table th { color: var(--muted); font-weight: 500; }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .panel { border: 1px solid #202020; border-radius: 8px; padding: 8px; background: #080808; }
    ul { margin: 7px 0 0; padding-left: 16px; }
    li { margin-bottom: 5px; font-size: 12px; color: #d4d4d8; }
    .graph-wrap { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; }
    .graph-box { border: 1px solid #202020; border-radius: 8px; background: #080808; padding: 8px; }
    .node { cursor: pointer; }
    .node circle { fill: #0f0f10; stroke: #fff; stroke-width: 1.5; }
    .node text { fill: #fff; font-size: 10px; }
    .node.active circle { fill: #fff; }
    .node.active text { fill: #000; }
    .edge { stroke: #5a5a5a; stroke-width: 1.2; }
    .empty { color: #f59e0b; font-size: 12px; display: none; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="side">
      <div class="brand">Cortex Visualizer</div>
      <div class="nav">
        <div class="active">Overview</div>
        <div>Ops Gate Board</div>
        <div>Memory Quality</div>
        <div>Reason Inspector</div>
        <div>Retrieval Debug</div>
        <div>Provenance Explorer</div>
      </div>
    </aside>
    <main class="main">
      <div class="top">
        <div>
          <h1>Visualizer v1 (prototype)</h1>
          <div class="sub">black/white shadcn-style shell • canonical backend + Obsidian adapter</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <a class="btn" id="obsidianBtn" href="./data/obsidian-graph.json" target="_blank" rel="noopener noreferrer">Open Obsidian adapter</a>
          <button class="btn" id="refreshBtn">Reload snapshot</button>
        </div>
      </div>
      <div class="meta" id="metaLine">loading…</div>
      <div class="empty" id="emptyBanner">No snapshot found. Run: <code>python3 scripts/visualizer_export.py</code></div>

      <section class="grid4">
        <article class="card"><div class="k">Release Readiness</div><div class="v" id="releaseReadiness">—</div><div class="small" id="releaseReason">—</div></article>
        <article class="card"><div class="k">Memory Quality Score</div><div class="v" id="qualityScore">—</div><div class="small" id="qualityDelta">—</div></article>
        <article class="card"><div class="k">Reason p95 Latency</div><div class="v" id="reasonP95">—</div><div class="small">from telemetry</div></article>
        <article class="card"><div class="k">Facts / 24h Growth</div><div class="v" id="factsGrowth">—</div><div class="small">snapshot growth signal</div></article>
      </section>

      <section class="row">
        <article class="card">
          <div class="title"><span>Ops Gate Board</span><span class="pill">PASS/WARN/FAIL</span></div>
          <div class="status-grid" id="gates"></div>
          <div class="spark">
            <svg id="trendSvg" viewBox="0 0 500 120" preserveAspectRatio="none"></svg>
          </div>
        </article>
        <article class="card">
          <div class="title"><span>Memory Quality Engine</span><span class="pill">composite</span></div>
          <div class="small">Conflict density</div><div class="meter"><span id="mConflict" style="width:0%"></span></div>
          <div class="small">Stale ratio pressure</div><div class="meter"><span id="mStale" style="width:0%"></span></div>
          <div class="small">Confidence health</div><div class="meter"><span id="mConf" style="width:0%"></span></div>
          <div class="small">Extraction yield</div><div class="meter"><span id="mYield" style="width:0%"></span></div>
          <ul id="actions"></ul>
        </article>
      </section>

      <section class="row2">
        <article class="card">
          <div class="title"><span>Reasoning Run Inspector</span><span class="pill">timeline</span></div>
          <table class="table">
            <thead><tr><th>Run</th><th>Mode</th><th>Latency</th><th>Tokens</th><th>Cost</th></tr></thead>
            <tbody id="runsBody"></tbody>
          </table>
        </article>
        <article class="card">
          <div class="title"><span>Retrieval Debug (query replay)</span><span class="pill">bm25 vs hybrid</span></div>
          <div class="split">
            <div class="panel"><div class="small">BM25 top</div><ul id="bm25List"></ul></div>
            <div class="panel"><div class="small">Hybrid top</div><ul id="hybridList"></ul></div>
          </div>
        </article>
      </section>

      <section class="card">
        <div class="title"><span>Provenance Explorer (clickable focused subgraph)</span><span class="pill">fact → source → outputs</span></div>
        <div class="graph-wrap">
          <div class="graph-box">
            <svg id="graphSvg" viewBox="0 0 700 220" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
          <div class="graph-box">
            <div class="small">Selected node</div>
            <div class="v" style="font-size:18px;margin:8px 0 6px" id="nodeLabel">(click a node)</div>
            <div class="small" id="nodeType">type: —</div>
            <div class="small" id="nodeSource" style="margin-top:4px">source: —</div>
            <div class="small" id="graphBounds" style="margin-top:4px">bounds: —</div>
            <ul id="nodeLinks"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const fmtNum = (n) => {
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
      if (n >= 1_000) return (n / 1_000).toFixed(1) + 'k';
      return String(n);
    };

    const REPO_BLOB_BASE = 'https://github.com/hurttlocker/cortex/blob/main/';
    let canonicalData = null;
    let activeGraph = null;

    function gateStatusClass(s) {
      if (s === 'PASS') return 'ok';
      if (s === 'WARN') return 'warn';
      if (s === 'NO_DATA') return 'warn';
      return 'bad';
    }

    function sourceHref(ref) {
      if (!ref || typeof ref !== 'string') return null;
      if (ref.startsWith('http://') || ref.startsWith('https://')) return ref;
      return REPO_BLOB_BASE + ref.replace(/^\/+/, '');
    }

    function renderTrend(svg, trend) {
      svg.innerHTML = '';
      const width = 500;
      [20, 60, 100].forEach(y => {
        const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        l.setAttribute('class', 'axis');
        l.setAttribute('x1', '0'); l.setAttribute('x2', String(width));
        l.setAttribute('y1', String(y)); l.setAttribute('y2', String(y));
        svg.appendChild(l);
      });
      const points = (trend || []).map((p, i) => {
        const x = (i / Math.max(1, trend.length - 1)) * width;
        const y = 110 - ((p.score || 0) / 100) * 90;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');
      const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      poly.setAttribute('class', 'line');
      poly.setAttribute('points', points);
      svg.appendChild(poly);
    }

    async function fetchCanonical(refresh = false) {
      const apiPath = `/api/v1/canonical${refresh ? '?refresh=1' : ''}`;
      try {
        const r = await fetch(apiPath, { cache: 'no-store' });
        if (r.ok) return await r.json();
      } catch (_) {}
      const fallback = await fetch('./data/latest.json?ts=' + Date.now());
      if (!fallback.ok) throw new Error(`fallback HTTP ${fallback.status}`);
      return fallback.json();
    }

    async function fetchSubgraph(focus, maxHops = 2, maxNodes = 200) {
      const q = new URLSearchParams({ focus: focus || '', max_hops: String(maxHops), max_nodes: String(maxNodes) });
      try {
        const r = await fetch(`/api/v1/subgraph?${q.toString()}`, { cache: 'no-store' });
        if (r.ok) return await r.json();
      } catch (_) {}
      return canonicalData?.data?.graph || { nodes: [], edges: [], bounds: { max_hops: maxHops, max_nodes: maxNodes }, focus: focus || '' };
    }

    function renderGraph(graph) {
      const svg = document.getElementById('graphSvg');
      svg.innerHTML = '';
      const nodes = (graph && graph.nodes) || [];
      const edges = (graph && graph.edges) || [];
      const byId = Object.fromEntries(nodes.map(n => [n.id, n]));

      document.getElementById('graphBounds').textContent = `bounds: hops≤${graph?.bounds?.max_hops ?? '-'} nodes≤${graph?.bounds?.max_nodes ?? '-'}`;

      edges.forEach(e => {
        const a = byId[e.from], b = byId[e.to];
        if (!a || !b) return;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('class', 'edge');
        line.setAttribute('x1', a.x); line.setAttribute('y1', a.y);
        line.setAttribute('x2', b.x); line.setAttribute('y2', b.y);
        svg.appendChild(line);
      });

      const nodeEls = new Map();

      const selectNode = (id) => {
        nodeEls.forEach(el => el.classList.remove('active'));
        const el = nodeEls.get(id);
        if (el) el.classList.add('active');

        const n = byId[id];
        if (!n) return;
        document.getElementById('nodeLabel').textContent = n.label;
        document.getElementById('nodeType').textContent = `type: ${n.type}`;

        const source = document.getElementById('nodeSource');
        const href = sourceHref(n.source_ref);
        if (href) {
          source.innerHTML = `source: <a href="${href}" target="_blank" rel="noopener noreferrer" style="color:#fff">${n.source_ref}</a>`;
        } else {
          source.textContent = 'source: —';
        }

        const links = edges.filter(e => e.from === id || e.to === id).map(e => {
          const other = e.from === id ? e.to : e.from;
          const label = byId[other]?.label || other;
          return `${e.kind} → ${label}`;
        });
        const ul = document.getElementById('nodeLinks');
        ul.innerHTML = '';
        links.forEach(txt => {
          const li = document.createElement('li'); li.textContent = txt; ul.appendChild(li);
        });
      };

      const expandFocus = async (id) => {
        const sub = await fetchSubgraph(id, graph?.bounds?.max_hops || 2, graph?.bounds?.max_nodes || 200);
        activeGraph = sub;
        renderGraph(activeGraph);
      };

      nodes.forEach(n => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'node');
        g.setAttribute('transform', `translate(${n.x},${n.y})`);

        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        c.setAttribute('r', '17');
        g.appendChild(c);

        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', '24'); t.setAttribute('y', '4');
        t.textContent = n.label;
        g.appendChild(t);

        g.addEventListener('click', () => selectNode(n.id));
        g.addEventListener('dblclick', () => expandFocus(n.id));
        svg.appendChild(g);
        nodeEls.set(n.id, g);
      });

      if (graph && graph.focus) selectNode(graph.focus);
      else if (nodes[0]) selectNode(nodes[0].id);
    }

    function bind(data) {
      canonicalData = data;
      const d = data.data || {};
      const ov = d.overview || {};
      const win = data.window || {};
      document.getElementById('metaLine').textContent = `generated ${data.generated_at || 'unknown'} • schema ${data.schema_version || 'n/a'} • window ${win.from || '?'} → ${win.to || '?'}`;
      document.getElementById('releaseReadiness').textContent = ov.release_readiness || '—';
      document.getElementById('releaseReason').textContent = (d.ops?.events?.[0]?.message) || 'no active warnings';
      document.getElementById('qualityScore').textContent = `${d.quality?.score ?? '—'}/100`;
      document.getElementById('qualityDelta').textContent = `${d.quality?.delta_24h ?? 0} in last 24h`;
      document.getElementById('reasonP95').textContent = `${ov.reason_p95_latency_s ?? 0}s`;
      document.getElementById('factsGrowth').textContent = `+${fmtNum(ov.facts_24h_growth || 0)}`;

      const gates = document.getElementById('gates');
      gates.innerHTML = '';
      const gateList = (d.ops?.gates || []);
      if (!gateList.length) {
        const el = document.createElement('div');
        el.className = 'status';
        el.innerHTML = `<div class="label"><span class="dot bad"></span>Gate data unavailable</div><div class="value">NO_DATA</div><div class="small">No gate payload in snapshot.</div>`;
        gates.appendChild(el);
      }

      gateList.forEach(g => {
        const el = document.createElement('div');
        el.className = 'status';
        const links = (g.evidence_links || []).map(l => `<a href="${l.href}" target="_blank" rel="noopener noreferrer">${l.label}</a>`).join(' • ');
        el.innerHTML = `
          <div class="label"><span class="dot ${gateStatusClass(g.status)}"></span>${g.label}</div>
          <div class="value">${g.status}</div>
          <div class="small">${g.reason || 'No reason provided.'}</div>
          ${links ? `<div class="small" style="margin-top:6px">Evidence: ${links}</div>` : ''}
        `;
        gates.appendChild(el);
      });

      renderTrend(document.getElementById('trendSvg'), d.ops?.trend || []);

      const f = d.quality?.factors || {};
      document.getElementById('mConflict').style.width = `${Math.round((f.conflict_density || 0) * 100)}%`;
      document.getElementById('mStale').style.width = `${Math.round((f.stale_pressure || 0) * 100)}%`;
      document.getElementById('mConf').style.width = `${Math.round((f.confidence_health || 0) * 100)}%`;
      document.getElementById('mYield').style.width = `${Math.round((f.extraction_yield || 0) * 100)}%`;

      const actions = document.getElementById('actions');
      actions.innerHTML = '';
      (d.quality?.actions || []).forEach(a => {
        const li = document.createElement('li'); li.textContent = a; actions.appendChild(li);
      });

      const runs = document.getElementById('runsBody');
      runs.innerHTML = '';
      (d.reason?.runs || []).slice(0, 6).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>#${r.run_id}</td><td>${r.mode}</td><td>${(r.latency_ms/1000).toFixed(1)}s</td><td>${fmtNum(r.tokens_total)}</td><td>$${(r.estimated_cost_usd || 0).toFixed(4)}</td>`;
        runs.appendChild(tr);
      });

      const bm25 = document.getElementById('bm25List');
      bm25.innerHTML = '';
      (d.retrieval?.results?.bm25 || []).forEach(x => { const li = document.createElement('li'); li.textContent = `#${x.rank} ${x.title}`; bm25.appendChild(li); });
      const hy = document.getElementById('hybridList');
      hy.innerHTML = '';
      (d.retrieval?.results?.hybrid || []).forEach(x => { const li = document.createElement('li'); li.textContent = `#${x.rank} ${x.title}`; hy.appendChild(li); });

      activeGraph = d.graph || {};
      renderGraph(activeGraph);
    }

    async function loadSnapshot(refresh = false) {
      const empty = document.getElementById('emptyBanner');
      try {
        const json = await fetchCanonical(refresh);
        empty.style.display = 'none';
        bind(json);
      } catch (e) {
        empty.style.display = 'block';
        console.error(e);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', () => loadSnapshot(true));
    loadSnapshot();
  </script>
</body>
</html>
