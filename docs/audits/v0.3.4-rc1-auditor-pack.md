# Cortex v0.3.4-rc1 Auditor Command Pack

Audit target:
- Repo: `hurttlocker/cortex`
- Tag: `v0.3.4-rc1`
- Expected focus: rollout report runtime integration + release hardening checks

## 1) Environment / provenance

```bash
git clone https://github.com/hurttlocker/cortex.git
cd cortex
git checkout v0.3.4-rc1

go version
```

## 2) Build + baseline tests

```bash
go test ./...
go vet ./...
go build -o ./bin/cortex ./cmd/cortex
./bin/cortex version
```

Expected:
- tests pass
- vet pass
- binary prints `cortex 0.3.4-rc1` (or release ldflags version)

## 3) Rollout report command behavior

### 3.1 Help path

```bash
./bin/cortex codex-rollout-report --help
echo $?
```

Expected:
- help text printed
- exit code `0`

### 3.2 No-file / missing-file path

```bash
./bin/cortex codex-rollout-report --file /tmp/does-not-exist.jsonl
echo $?
```

Expected:
- report renders with `Runs parsed: 0`
- exit code `0`

### 3.3 Strict guardrail failure signaling

```bash
cat > /tmp/cortex-audit-telemetry.jsonl <<'EOF'
{"mode":"one-shot","provider":"openrouter","model":"openai-codex/gpt-5.2","wall_ms":25000,"cost_known":true,"cost_usd":0.001}
{"mode":"recursive","provider":"openrouter","model":"google/gemini-2.5-flash","wall_ms":30000,"cost_known":false}
EOF

./bin/cortex codex-rollout-report --file /tmp/cortex-audit-telemetry.jsonl --warn-only=false
echo $?
```

Expected:
- WARN lines for one-shot p95 and recursive known-cost completeness
- non-zero exit (runtime path should return `2`)

### Strict mode exit semantics (authoritative)
- Runtime CLI (`./bin/cortex codex-rollout-report --warn-only=false`) returns **exit `2`** on guardrail warnings.
- Script/go-run path (`./scripts/codex_rollout_report.sh ... --warn-only=false`) returns **non-zero** on guardrail warnings.
  - Exact code may differ by launcher/wrapper behavior.

## 4) Script compatibility path

```bash
./scripts/codex_rollout_report.sh /tmp/cortex-audit-telemetry.jsonl --warn-only=false
echo $?
```

Expected:
- report output
- non-zero exit in strict mode
- note: exact code may differ under `go run`; treat any non-zero as failure

## 5) Guide fixture regression check (#59)

```bash
rg -n "Concurrent Note|substantive" tests/AUDIT.md
```

Expected:
- test 9e fixtures include substantive content, not low-signal one-liners

## 6) Audit-track issue hygiene spot-checks (#60/#61/#62)

```bash
# #60 dedupe race on concurrent identical imports
go test ./internal/ingest -run TestProcessMemory_ConcurrentIdenticalImports_NoUniqueErrors -v

# #61 malformed/zero PID embed lock reclaim
go test ./cmd/cortex -run 'TestAcquireEmbedRunLock_Reclaims(MalformedPIDLock|ZeroPIDLock)' -v

# #62 stale migration in_progress claim recovery
go test ./internal/store -run 'Test(ClaimMetaMigration_ReclaimsDeadPID|MigrateFTSMultiColumn_RecoverStaleInProgressMarker)' -v
```

Expected:
- all tests pass
- no SQLITE unique-constraint surfacing from concurrent identical imports
- malformed/zero PID lock files are reclaimed
- stale migration claims are reclaimed and migration proceeds

## 7) Audit notes template

Capture:
- commit/tag tested
- full command transcript
- mismatches vs expected behavior
- pass/fail per section
- suggested regressions / follow-ups
